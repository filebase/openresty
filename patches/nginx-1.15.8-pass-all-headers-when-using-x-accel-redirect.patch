From ffad826f902596760ffeca391c29b4d00f876c46 Mon Sep 17 00:00:00 2001
From: Filebase <hello@filebase.com>
Date: Sat, 7 Sep 2019 00:14:18 -0400
Subject: [PATCH] Pass all headers when using X-Accel-Redirect

---
 src/http/ngx_http_upstream.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/src/http/ngx_http_upstream.c b/src/http/ngx_http_upstream.c
index 89e1319f..5ff14556 100644
--- a/src/http/ngx_http_upstream.c
+++ b/src/http/ngx_http_upstream.c
@@ -2740,6 +2740,12 @@ ngx_http_upstream_process_headers(ngx_http_request_t *r, ngx_http_upstream_t *u)
                 i = 0;
             }
 
+            if (ngx_hash_find(&u->conf->hide_headers_hash, h[i].hash,
+                            h[i].lowcase_key, h[i].key.len))
+            {
+                continue;
+            }
+
             hh = ngx_hash_find(&umcf->headers_in_hash, h[i].hash,
                                h[i].lowcase_key, h[i].key.len);
 
@@ -2749,6 +2755,13 @@ ngx_http_upstream_process_headers(ngx_http_request_t *r, ngx_http_upstream_t *u)
                                               NGX_HTTP_INTERNAL_SERVER_ERROR);
                     return NGX_DONE;
                 }
+                continue;
+            }
+
+            if (ngx_http_upstream_copy_header_line(r, &h[i], 0) != NGX_OK) {
+                ngx_http_upstream_finalize_request(r, u,
+                                                NGX_HTTP_INTERNAL_SERVER_ERROR);
+                return NGX_DONE;
             }
         }
 
-- 
2.20.1 (Apple Git-117)

